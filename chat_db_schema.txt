organizations
-------------
id                 text PRIMARY KEY
created_at         timestamptz DEFAULT now()
is_email_verified  boolean DEFAULT false
name               text
logo_url           text
address            jsonb
email              text
phone              text
email_token        text


users
-----
id                 uuid PRIMARY KEY
created_at         timestamptz DEFAULT now()
updated_at         timestamptz DEFAULT now()

email              text UNIQUE
email_verified     boolean DEFAULT false
email_verified_at  timestamptz
password_hash      text
phone              text
phone_verified     boolean DEFAULT false
phone_verified_at  timestamptz

full_name          text
avatar_url         text

google_id          text UNIQUE
github_id          text UNIQUE
microsoft_id       text UNIQUE
google_email       text
github_email       text
microsoft_email    text

last_logged_in     timestamptz
last_logged_in_ip  text

is_active          boolean DEFAULT true
is_banned          boolean DEFAULT false
banned_until       timestamptz
onboarding_completed boolean DEFAULT false


organization_members
--------------------
id                uuid PRIMARY KEY
created_at        timestamptz DEFAULT now()
organization_id   text REFERENCES organizations(id)
user_id           uuid REFERENCES users(id)
role              text


organization_invites
--------------------
id                uuid PRIMARY KEY
organization_id   text REFERENCES organizations(id)
email             text
role              text DEFAULT 'editor'
created_at        timestamptz DEFAULT now()
accepted_at       timestamptz


bots
----
id                       uuid PRIMARY KEY
created_at               timestamptz DEFAULT now()
name                     text NOT NULL
capture_leads            boolean DEFAULT false
updated_at               timestamptz DEFAULT now()
organization_id          text REFERENCES organizations(id)
tone                     text
role                     text
business_description     text

first_message            text
confirmation_message     text
lead_capture_message     text
lead_capture_timing      text CHECK (
  lead_capture_timing IN ('start','after_first')
)

capture_name             boolean DEFAULT false
capture_email            boolean DEFAULT false
capture_phone            boolean DEFAULT false


api_keys
--------
id                uuid PRIMARY KEY
name              text
key_hash          text NOT NULL
created_at        timestamptz DEFAULT now()
organization_id   text REFERENCES organizations(id)
bot_id            uuid REFERENCES bots(id)
is_active         boolean DEFAULT true
last_used_at      timestamptz DEFAULT now()


conversations_meta
------------------
id                   uuid PRIMARY KEY
created_at           timestamptz DEFAULT now()
mode                 text DEFAULT 'ai'
organization_id      text REFERENCES organizations(id)
bot_id               uuid REFERENCES bots(id)
api_key_id           uuid REFERENCES api_keys(id)
user_name            text
user_email           text
status               text
last_message_snippet text
last_message_at      timestamptz


leads
-----
id                   uuid PRIMARY KEY
captured_at          timestamptz DEFAULT now()
name                 text
email                text
phone                text
organization_id      text REFERENCES organizations(id)
bot_id               uuid REFERENCES bots(id)
conversation_id      uuid REFERENCES conversations_meta(id)


training_sources
----------------
id                   uuid PRIMARY KEY
created_at           timestamptz DEFAULT now()
organization_id      text REFERENCES organizations(id)
bot_id               uuid REFERENCES bots(id)
type                 text
status               text
error_message        text
source_value         text


files
-----
id                   uuid PRIMARY KEY
created_at           timestamptz DEFAULT now()
organization_id      text REFERENCES organizations(id)
bot_id               uuid REFERENCES bots(id)
provider             text DEFAULT 'r2'
bucket               text
path                 text
original_filename    text
mime_type            text
size_bytes           bigint
purpose              text
status               text


otps
----
id                   uuid PRIMARY KEY
created_at           timestamptz DEFAULT now()
user_id              uuid REFERENCES users(id)
code                 text
type                 text CHECK (type IN ('EMAIL','MOBILE'))
purpose              text CHECK (purpose IN ('LOGIN','VERIFY_EMAIL','VERIFY_PHONE','RESET_PASSWORD'))
email                text
phone                text
expires_at           timestamptz
used_at              timestamptz
is_used              boolean DEFAULT false
attempts             int DEFAULT 0
max_attempts         int DEFAULT 5
ip_address           text
user_agent           text
